name: Rclone Sync

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'å¯ç”¨ Dry Run æ¨¡å¼ï¼ˆä»…æ¨¡æ‹Ÿï¼Œä¸å®é™…åŒæ­¥ï¼‰'
        type: boolean
        default: false

jobs:
  rclone-syncProcess:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Set up Rclone config securely
        env:
          RCLONE_CONFIG_CONTENT: ${{ secrets.RCLONE_CONF }}
        run: |
          mkdir -p "$HOME/.config/rclone"
          # ä½¿ç”¨ printf é¿å… EOF ä¸­çš„ç¼©è¿›/è½¬ä¹‰é—®é¢˜
          printf '%s\n' "$RCLONE_CONFIG_CONTENT" > "$HOME/.config/rclone/rclone.conf"
          chmod 600 "$HOME/.config/rclone/rclone.conf"

      - name: Prepare sync options
        id: sync_opts
        run: |
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            echo "DRY_RUN=--dry-run" >> "$GITHUB_ENV"
            echo "âš ï¸ DRY RUN æ¨¡å¼ï¼šä¸ä¼šæ‰§è¡Œå®é™…åŒæ­¥ï¼"
          else
            echo "DRY_RUN=" >> "$GITHUB_ENV"
          fi

      - name: Run Rclone Sync
        env:
          SOURCE: ${{ vars.SOURCE_REMOTE || 'onedrive:' }}
          DEST:   ${{ vars.DEST_REMOTE   || 'googledrive:' }}
        run: |
          echo "ğŸ”„ åŒæ­¥æº: $SOURCE"
          echo "ğŸ¯ åŒæ­¥ç›®æ ‡: $DEST"
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œ rclone sync..."

          rclone sync \
            ${{ env.DRY_RUN }} \
            --verbose \
            --progress \
            --transfers=8 \
            --checkers=16 \
            --contimeout=60s \
            --timeout=300s \
            --retries=3 \
            --low-level-retries=2 \
            --stats=10s \
            --drive-use-trash=false \
            "$SOURCE" "$DEST"

      - name: Sync completed successfully
        if: success()
        run: echo "âœ… åŒæ­¥å®Œæˆï¼"

      - name: Sync failed â€“ please check logs
        if: failure()
        run: |
          echo "âŒ åŒæ­¥å¤±è´¥ï¼è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š"
          echo "1. RCLONE_CONF æ˜¯å¦æ­£ç¡®é…ç½®ï¼Ÿ"
          echo "2. ç½‘ç›˜æ˜¯å¦æˆæƒä¸” token æœ‰æ•ˆï¼Ÿ"
          echo "3. æºå’Œç›®æ ‡è·¯å¾„æ˜¯å¦å­˜åœ¨ï¼Ÿ"
